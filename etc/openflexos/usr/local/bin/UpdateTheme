#!/usr/bin/env bash
set -e

THEMES_FILE="$HOME/.config/themes.json"
SOCKET="$HOME/.cache/qtile/qtilesocket.:0"
source "$HOME/.config/dmenu_theme.conf"

# Terminal & editor (Qtile usually sets TERMINAL)
TERMINAL="${TERMINAL:-alacritty}"
EDITOR_CMD="${EDITOR:-vim}"

# ---------------------------
# Parse command-line options
# ---------------------------
while getopts "dr" opt; do
    case $opt in
        d)
            menu_backend="dmenu"
            dmenu_cmd=(
                dmenu
                -nb "$DMENU_NB"
                -nf "$DMENU_NF"
                -sb "$DMENU_SB"
                -sf "$DMENU_SF"
            )
            ;;
        r)
            menu_backend="rofi"
            rofi_cmd=(
                rofi
                -config "$HOME/.config/qtile/rofi/config.rasi"
            )
            ;;
        *)
            echo "Usage: $0 [-d] [-r]"
            exit 1
            ;;
    esac
done

if [[ -z "$menu_backend" ]]; then
    echo "Error: You must choose -d (dmenu) or -r (rofi)"
    exit 1
fi

# ---------------------------
# Load sound configuration
# ---------------------------
if pgrep -x qtile >/dev/null; then
    source "$HOME/.config/qtile/scripts/OpenFlexOS_Sounds.sh"
elif pgrep -x openbox >/dev/null; then
    source "$HOME/.config/openbox/scripts/OpenFlexOS_Sounds.sh"
fi

# ---------------------------
# Load themes dynamically
# ---------------------------
mapfile -t themes < <(jq -r '.themes | keys[]' "$THEMES_FILE" | sort)
current_theme=$(jq -r '.current' "$THEMES_FILE")

# Build menu list with Active label
themes_menu=()
for theme in "${themes[@]}"; do
    if [[ "$theme" == "$current_theme" ]]; then
        themes_menu+=("$theme (Active)")
    else
        themes_menu+=("$theme")
    fi
done

# ---------------------------
# Menu helpers
# ---------------------------
menu() {
    local prompt="$1"
    shift

    case "$menu_backend" in
        dmenu)
            [[ "$active_sounds" == yes && -f "${sounds_dir}${dmenu_sound}" ]] \
                && mpv --no-video --no-terminal "${sounds_dir}${dmenu_sound}" >/dev/null 2>&1 &

            printf "%s\n" "$@" | "${dmenu_cmd[@]}" -p "$prompt" -l 10
            ;;
        rofi)
            [[ "$active_sounds" == yes && -f "${sounds_dir}${rofi_sound}" ]] \
                && mpv --no-video --no-terminal "${sounds_dir}${rofi_sound}" >/dev/null 2>&1 &

            printf "%s\n" "$@" | "${rofi_cmd[@]}" -dmenu -p "$prompt" -i
            ;;
    esac
}

# ---------------------------
# Actions
# ---------------------------
choose_theme() {
    local selected clean_theme

    selected=$(menu "Select Theme:" "${themes_menu[@]}")
    [[ -z "$selected" ]] && return

    # Remove " Active" suffix if present
    clean_theme="${selected% Active}"

    jq --arg theme "$clean_theme" '.current = $theme' \
        "$THEMES_FILE" > "$THEMES_FILE.tmp" && mv "$THEMES_FILE.tmp" "$THEMES_FILE"

    apply_theme
}

edit_themes() {
    if [[ -t 1 ]]; then
        "$EDITOR_CMD" "$THEMES_FILE"
    else
        "$TERMINAL" -e "$EDITOR_CMD" "$THEMES_FILE" &
    fi
}

apply_theme() {
    local current
    current=$(jq -r '.current' "$THEMES_FILE")
    echo "Applying theme: $current"

    restart_qtile
    bash update-ohmyposh.sh
    bash update-rofi-theme.sh
    bash update_dmenu_theme.sh
    bash update-alacritty-theme.sh
    bash update-dunst-theme.sh
    bash update-gtk2-theme.sh
    bash update-gtk3-theme.sh
    bash update-gtk4-theme.sh
    bash update_picom_theme.sh
    bash update-conky-theme.sh
}

restart_qtile() {
    echo "Restarting Qtile..."
    qtile cmd-obj -o cmd -f restart || true

    for i in {1..50}; do
        if qtile cmd-obj -s "$SOCKET" -o cmd -f info >/dev/null 2>&1; then
            echo "Qtile restarted successfully."
            return
        fi
        sleep 0.2
    done

    echo "⚠️  Qtile restart timed out or IPC not ready."
}

# ---------------------------
# Main menu
# ---------------------------
action=$(menu "Theme Manager:" \
    "Choose a theme" \
    "Edit themes.json" \
    "Apply theme"
)

case "$action" in
    "Choose a theme")   choose_theme ;;
    "Edit themes.json") edit_themes ;;
    "Apply theme")     apply_theme ;;
    *) exit 0 ;;
esac
